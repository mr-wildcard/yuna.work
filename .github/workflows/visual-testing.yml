name: Run visual testing

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:
  visual-testing:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'visual-testing') || startsWith(github.head_ref, 'renovate/') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repository using git
        uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install
        shell: bash
        run: pnpm i

      - name: Derive Cloudflare latest preview build URL
        id: cloudflare_preview
        run: |
          short_sha="${GITHUB_SHA::7}"
          host="${short_sha}.yuna-work.pages.dev"
          url="https://${host}"
          echo "preview_host=${preview_host}" >> "$GITHUB_OUTPUT"
          echo "preview_url=${preview_url}" >> "$GITHUB_OUTPUT"

      - name: Take yuna.work screenshots and upload them to Percy
        run: |
          pnpm wait-on "https-get://${CLOUDFLARE_PREVIEW_HOST}" --httpTimeout=2m
          pnpm percy snapshot .percy.mjs --verbose
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          CLOUDFLARE_PREVIEW_HOST: ${{ steps.cloudflare_preview.outputs.preview_host }}
          CLOUDFLARE_PREVIEW_URL: ${{ steps.cloudflare_preview.outputs.preview_url }}
          ASTRO_PREVIEW_SERVER_PORT_FOR_VISUAL_TESTING: 4321
